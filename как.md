# Ортофото инструкция к действию

## Содержание: 
* Общий алгоритм	
* Подробнее о программах
* Pix4D Mapper
* DroneDeploy
* Agisoft PhotoScan	
* OpenDroneMap	
* Съемка по маршруту	
* Pix4Capture	
* Общие рекомендации	
* Важность выбора погоды	
* Выбор места взлёта дрона	
* Вопросы:	


# Общий алгоритм
1. Купить DJI Mavic / Phantom
1. Зарегистрироваться на pix4d.com
1. Поставить Pix4D Capture и Ctrl+DJI 
   1. зайти в расширенные настройки и включить экспертный режим
1. Нарисовать прямоугольник 
   1. за одну батарейку можно облететь: 
      1. 1км х 1км в один слой на высоте 220м
1. Нажать Start
1. Подождать облёт
1. Вытащить флешку, вставить в компьютер
1. Открыть в браузере cloud.pix4d.com (альтернатива — dronedeploy.com, алгоритм аналогичный)
1. Создать новый проект
1. Перетащить туда все фото с флешки
1. Подождать 2-8 часов. (Фотографии за один полёт будут собираться в карту ~1,5 часа, за 8 полётов  ~8 часов.
1. Скачать geotiff (Orthomosaic, transparent_mosaic_group) и DEM geotiff  (DSM)
1. Пойти на openaerialmap.org и зарегистрировать аккаунт
1. Закачать geotiff

# Подробнее о программах
Для процессинга на домашнем компьютере важно иметь много ОЗУ и включённый swap. Можно воспользоваться веб-сервисом от Pix4D.
## Pix4D Mapper
https://support.pix4d.com/hc/en-us/articles/214483743
Есть облачная веб-версия, работает в стиле "загрузил пачку фото — получил результат через N часов". Доступна в триал-версии.
Особенности работы софта от Pix4D — итоговая картинка ортомозаики формируется через многократные наложения полупрозрачных перекрывающихся фото, из-за чего резкие контуры немного размываются, зато убираются движущиеся автомобили. Также есть артефакты в районе фонарей, деревьев и т.д.

## DroneDeploy
https://www.dronedeploy.com/
Также предоставляет облачный сервис, доступный и в пробном режиме. Ограничения пробной версии — нельзя добавлять GCP (точки привязки) и скачивать результат в разных проекциях, а также есть ограничения на количество исходных фото и разрешение результирующего файла. В отличие от Pix4D, не накладывает фото друг на друга, а режет и склеивает их, соответственно, контуры чётче, но появляются другие артефакты вроде половины едущего автомобиля.
Также есть своё приложение для планирования миссий, как и у Pix4D.

## Agisoft PhotoScan
В качестве альтернативы для Pix4D для процессинга фотографий можно использовать софт Agisoft PhotoScan
В неё можно заливать просто набор готовых фотографий из дрона, сгенеренных после выполнения миссии в Pix4D Capture. Инструкция по следующей ссылке:
https://blog.sketchfab.com/uavdrone-survey-agisoft-photoscan-part-2/

## OpenDroneMap
Отрытое ПО способное собрать ортофото и 3д карту из фотографий или видео. 

* Офф сайт - http://opendronemap.org/
* Wiki - https://github.com/OpenDroneMap/OpenDroneMap/wiki
* GitHub - https://github.com/OpenDroneMap/OpenDroneMap
* http://wiki.gis-lab.info/OpenDroneMap


# Съемка по маршруту
## Pix4Capture
Высота выбирается в программе Pix4Capture. Программа делает расчёт времени полёта дрона исходя из маршрута и высоты. Чаще всего для высот 180-240 метров время минимальное. Для выбора больших высот надо зайти в настройки и перейти в режим эксперта.
Из опыта прогнозное время полёта, вписывающееся до разряда батареии до 30% — около 13-15 минут. Фактическое зависит от ветра и количества поворотных точек.

Pix4Capture имеет 4 типа маршрута:
* 2D - пролёт змейкой, камера опущена ровно вниз.
* 3D - делает 2 змейки перпендикулярно друг другу, камера смотрит под углом к земле.
* Полигон — пролёт змейкой в рамках заданного произвольного полигона
* Съёмка здания - летает вокруг здания и фотографирует под углом. Дрон летает по маршруту с привязкой к gps и на уровне или чуть выше здания. Нужно очень аккуратно составить маршрут, чтобы он ни во что не врезался, потому что лететь будет боком.
* Ручной режим.

## Общие рекомендации
При съёмке дрон двигается со скорость до 10 м/с (режим GPS), если света не будет хватать фотографии будут смазанными. Хорошо если выдержка меньше 1/450.
Много времени тратится на повороты, поэтому при планировании миссии не "квадратами" лучше ориентировать линии маршрута вдоль длинной стороны полигона.
При сильном ветре (более 5-7 м/с) дрону будет очень сложно выполнить полёт по маршруту.  Тут есть два варианта: 
1. Сделать проект так, чтобы длинные линии полёта были поперёк ветра, а путь от конца маршрута к точке финиша был по ветру.
1. Перейти в режим Sport (в нём дрон может летать со скоростью до 16,6 м/с) и попробовать сделать снимки вручную.
При этом обязательно следить за уровнем заряда, так чтобы его хватило вернуться назад и приземлиться (скорость спуска Mavic Pro 3 м/с, а подъёма 5 м/с). Когда батарея разряжается, падает в первую очередь напряжение и поэтому идёт большее потребление тока. Из-за этого проценты после 30-35% будут расходоваться за несколько секунд и чем меньше процентов, тем меньше секунд.

### Важность выбора погоды
* Солнечный день
* Отсутствие сильного ветра
можно посмотреть на https://www.uavforecast.com/ или в соответствующем мобильном приложении

### Выбор места взлёта дрона
* Ровная поверхность
* Возвышенность или открытая местность
* Выделяющаяся поверхность:  
  * Свой [launchpad](https://www.amazon.com/Hoodman-Drone-Launch-Pad-Diameter/dp/B01I0E821G) 
  * Мелками на асфальте нарисовать стартовую площадку

### Технические неполадки при использовании Pix4D Capture
* Бывает, что камера не фокусируется, и вся съёмка идёт насмарку. Подробнее [тут](https://support.pix4d.com/hc/en-us/community/posts/115000344366-DJI-Mavic-Pro-Autofocus-Issue-Android-). Та же проблема наблюдается и с приложением DroneDeploy: [форум](https://mavicpilots.com/threads/dronedeploy-autofocus-problem-mavic-pro.35364/). Пока единственное найденное рабочее решение — взлетать с помощью DJI GO до нужной высоты, устанавливать фокус, а затем переключаться на нужное приложение.
* Был случай, когда в процессе миссии телефон терял связь с пультом и затем после переподключения возобновить миссиию в Pix4D Capture не удавалось.

При съёмке больших пространств, возможна ситуация, когда прямоугольник проекта в стороне от точки старта. В этой ситуации, пока дрон будет лететь к точке начала маршрута, можно фотографировать и тем самым итоговая площадь ортофото увеличится. Самый главный ресурс дрона - аккумулятор.

# Вопросы:
Как обрабатывать geotiff в случае, если поехала привязка к GPS и/или изображение получилось геометрически растянутым/сжатым.
